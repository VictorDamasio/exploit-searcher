#/bin/bash

echo "This script needs to be run as root to install cve_searchsploit in /opt directory, in case you don't have it. Be sure to have enough permissions if you wish to proceed";

var=$(which cve_searchsploit);

if [ -z "$var" ]
then
        echo "cve_searchsploit not found, would you like to install it? (y/n)";
        read;
        if [ "${REPLY}" == "n" ]
        then
                echo "Ok, then. Keep your secrets.";
                exit 0;
        elif [ "${REPLY}" == "y" ]
        then
                git clone https://github.com/andreafioraldi/cve_searchsploit /opt/cve_searchsploit;
                cd /opt/cve_searchsploit;
                python3 setup.py install;
        else
                echo "Invalid input, terminating program"
                exit 0;
        fi
fi

echo "Reading scan file... this may take some time if the file is too large";

result="$(grep -P -i -o 'CVE-\d{4}-\d{4,7}' $1 | sort -u)";

echo "Generating results...";

str=""
saida=""

while IFS= read -r i;
do
        str=$(cve_searchsploit $i | grep -i "Exploit DB" -A 6 -B 4);
        if [ "$str" != "" ]
        then
                saida+="$(echo -e "$str")"$'\n';
                codigo+="$(grep "Exploit DB" <<< "$str" | cut -d ":" -f 2 | cut -d " " -f 2)"$'\n';
        fi
done <<< "$result"

codigo=$(sort -u <<<"$codigo");

touch saida.txt;
echo -e "$saida" > saida.txt;

echo "Generating file with list of exploit IDs you can search for..."
links=$(sed 's/^/https:\/\/www.exploit-db.com\/exploits\//' <<< $codigo);
echo -e "$links" > exploitIDs.txt;
echo "File generated. Would you like to open those links with Firefox? (That may slow your machine down) (y/n)"
read;
if [ "${REPLY}" == "y" ]
then
        firefox $(echo -e "$links") &
elif [ "${REPLY}" == "n" ]
then
        echo "Ok. Bye!"
else
        echo "I don't know what you're trying to do, but goodbye anyway!"
fi

echo "File saida.txt contains the search output";
echo "File exploitIDs.txt contains the links to all the exploits";
